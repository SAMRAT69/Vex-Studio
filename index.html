<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vex IDE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/skulpt/1.1.0/skulpt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/skulpt/1.1.0/skulpt-stdlib.js"></script>
    <style>
        /* Add your CSS styles here */
    </style>
</head>
<body>
    <div class="tab-bar" id="tabBar"></div>
    <div class="title-bar">
        <button class="imgui-button" id="settingsButton">⚙️ Settings</button>
        <button class="imgui-button" id="newTabButton">➕ New Tab</button>
        <select class="imgui-button" id="languageSelect">
            <option value="python">Python</option>
            <option value="lua">Lua</option>
            <option value="javascript">JavaScript</option>
            <option value="html">HTML</option>
            <option value="css">CSS</option>
        </select>
        <button class="imgui-button" id="runButton">▶ Run (Ctrl+Enter)</button>
    </div>

    <div class="editor-wrapper">
        <div class="gutter" id="gutter"></div>
        <div class="editor-content">
            <div id="editor" contenteditable spellcheck="false"></div>
        </div>
    </div>

    <div class="console" id="console"></div>

    <div class="settings-panel" id="settingsPanel">
        <div class="theme-grid">
            <div class="theme-option" style="background: #1E1E1E" data-theme="default"></div>
            <div class="theme-option" style="background: #2D2D2D" data-theme="dark"></div>
            <div class="theme-option" style="background: #002B36" data-theme="solarized"></div>
        </div>
        <div class="font-grid">
            <div class="font-option" data-font="Cascadia Code">Cascadia</div>
            <div class="font-option proggy" data-font="Proggy Clean">Proggy</div>
        </div>
    </div>

    <script>
        class IDEEditor {
            constructor() {
                this.editor = document.getElementById('editor');
                this.gutter = document.getElementById('gutter');
                this.console = document.getElementById('console');
                this.tabs = [];
                this.activeTabId = null;
                this.tabCounter = 1;
                this.lastSelection = null;
                this.highlightTimeout = null;

                this.syntaxRules = {
                    python: [
                        { regex: /(#.*)$/gm, class: 'comment' },
                        { regex: /(?:"(?:[^"\\]|\\.)*"|'(?:[^'\\]|\\.)*')/g, class: 'string' },
                        { regex: /\b(def|class|if|else|elif|for|while|return|import|from|as|try|except|finally|with|raise)\b/g, class: 'keyword' },
                        { regex: /\b([A-Za-z_][A-Za-z0-9_]*)(?=\()/g, class: 'function' },
                        { regex: /\b\d+\.?\d*\b/g, class: 'number' }
                    ],
                    lua: [
                        { regex: /(--\[\[[\s\S]*?]]|--.*)$/gm, class: 'comment' },
                        { regex: /(?:"(?:[^"\\]|\\.)*"|'(?:[^'\\]|\\.)*')/g, class: 'string' },
                        { regex: /\b(function|end|if|then|else|elseif|for|while|repeat|until|return|local)\b/g, class: 'keyword' },
                        { regex: /\b\d+\.?\d*\b/g, class: 'number' }
                    ],
                    javascript: [
                        { regex: /(\/\/.*|\/\*[\s\S]*?\*\/)$/gm, class: 'comment' },
                        { regex: /(?:"(?:[^"\\]|\\.)*"|'(?:[^'\\]|\\.)*')/g, class: 'string' },
                        { regex: /\b(function|class|if|else|for|while|return|import|export|try|catch|finally|throw)\b/g, class: 'keyword' },
                        { regex: /\b([A-Za-z_][A-Za-z0-9_]*)(?=\()/g, class: 'function' },
                        { regex: /\b\d+\.?\d*\b/g, class: 'number' }
                    ],
                    html: [
                        { regex: /(<!--[\s\S]*?-->)$/gm, class: 'comment' },
                        { regex: /(?:"(?:[^"\\]|\\.)*"|'(?:[^'\\]|\\.)*')/g, class: 'string' },
                        { regex: /<\/?[A-Za-z0-9-]+(?:\s+[A-Za-z0-9-]+(?:=(?:"[^"]*"|'[^']*'|[^'"\s]+))?\s*\/?>/g, class: 'keyword' }
                    ],
                    css: [
                        { regex: /(\/\*[\s\S]*?\*\/)$/gm, class: 'comment' },
                        { regex: /(?:"(?:[^"\\]|\\.)*"|'(?:[^'\\]|\\.)*')/g, class: 'string' },
                        { regex: /\b([A-Za-z-]+)\s*:/g, class: 'keyword' },
                        { regex: /#[0-9A-Fa-f]{3,6}\b/g, class: 'number' }
                    ]
                };

                this.init();
            }

            init() {
                this.initTabs();
                this.initEditorEvents();
                this.initTabEvents();
                this.initSettings();
                this.loadPreferences();

                // Bind button events
                document.getElementById('settingsButton').addEventListener('click', () => this.toggleSettings());
                document.getElementById('newTabButton').addEventListener('click', () => this.newTab());
                document.getElementById('runButton').addEventListener('click', () => this.executeCode());

                document.getElementById('languageSelect').addEventListener('change', () => {
                    this.updateHighlight();
                    this.saveTabs();
                });

                Sk.configure({
                    output: (text) => this.appendConsoleOutput(text),
                    read: (name) => {
                        if (Sk.builtinFiles.files[name] === undefined) {
                            throw `File not found: '${name}'`;
                        }
                        return Sk.builtinFiles.files[name];
                    }
                });
            }

            toggleSettings() {
                const panel = document.getElementById('settingsPanel');
                panel.classList.toggle('visible');
            }

            newTab() {
                this.createTab({ title: `Untitled ${this.tabCounter}`, content: '' });
            }

            executeCode() {
                const activeTab = this.tabs.find(t => t.id === this.activeTabId);
                if (!activeTab) return;

                this.console.innerHTML = '';
                this.console.classList.add('visible');

                try {
                    if (activeTab.language === 'python') {
                        Sk.misceval.asyncToPromise(() => 
                            Sk.importMainWithBody("<stdin>", false, activeTab.content, true)
                        ).catch(e => {
                            this.appendConsoleOutput(`<span class="error">${e.toString()}</span>`);
                        });
                    } else if (activeTab.language === 'javascript') {
                        const output = [];
                        const print = (...args) => output.push(args.join(' '));
                        new Function('print', activeTab.content)(print);
                        this.appendConsoleOutput(output.join('<br>'));
                    } else if (activeTab.language === 'lua') {
                        const output = [];
                        const print = (...args) => output.push(args.join(' '));
                        new Function('print', activeTab.content)(print);
                        this.appendConsoleOutput(output.join('<br>'));
                    } else if (activeTab.language === 'html') {
                        const iframe = document.createElement('iframe');
                        iframe.style.display = 'none';
                        document.body.appendChild(iframe);
                        iframe.contentDocument.open();
                        iframe.contentDocument.write(activeTab.content);
                        iframe.contentDocument.close();
                        this.appendConsoleOutput('HTML rendered successfully.');
                        document.body.removeChild(iframe);
                    } else if (activeTab.language === 'css') {
                        const style = document.createElement('style');
                        style.textContent = activeTab.content;
                        document.head.appendChild(style);
                        this.appendConsoleOutput('CSS applied successfully.');
                        document.head.removeChild(style);
                    }
                } catch(e) {
                    this.appendConsoleOutput(`<span class="error">${e.message}</span>`);
                }
            }

            // Add other methods here...
        }

        const ide = new IDEEditor();

        document.addEventListener('keydown', e => {
            if (e.ctrlKey && e.key === 'Enter') {
                ide.executeCode();
                e.preventDefault();
            }
        });
    </script>
</body>
</html>
